-- 修复 school_id 关联和清理初中数据

-- ============================================
-- 1. 更新 school_id 关联（精确匹配）
-- ============================================

-- 完全匹配
UPDATE ref_admission_score_unified u
SET school_id = s.id, updated_at = CURRENT_TIMESTAMP
FROM ref_school s
WHERE u.year = 2025 AND u.school_id IS NULL
  AND u.district_id = s.district_id
  AND u.school_name = s.full_name;

-- 去掉"上海市"前缀后匹配
UPDATE ref_admission_score_unified u
SET school_id = s.id, updated_at = CURRENT_TIMESTAMP
FROM ref_school s
WHERE u.year = 2025 AND u.school_id IS NULL
  AND u.district_id = s.district_id
  AND (u.school_name = REPLACE(s.full_name, '上海市', '')
       OR s.full_name = '上海市' || u.school_name);

-- 特殊匹配：去掉后缀
UPDATE ref_admission_score_unified u
SET school_id = s.id, updated_at = CURRENT_TIMESTAMP
FROM ref_school s
WHERE u.year = 2025 AND u.school_id IS NULL
  AND u.district_id = s.district_id
  AND (
    -- 华东师范大学第一附属中学
    (s.full_name = '华东师范大学第一附属中学' AND u.school_name = '上海市华东师范大学第一附属中学')
    -- 上海理工大学附属中学
    OR (s.full_name = '上海市上海理工大学附属中学' AND u.school_name = '上海理工大学附属中学')
    -- 南汇中学
    OR (s.full_name = '上海南汇中学' AND u.school_name = '上海市南汇中学')
    -- 浦实高级中学
    OR (s.full_name = '上海市浦东新区民办浦实高级中学' AND u.school_name = '上海浦东新区民办浦实高级中学')
    -- 青浦协和
    OR (s.full_name = '上海青浦区协和双语学校' AND u.school_name = '上海市青浦区协和双语学校')
    -- 七宝浦江
    OR (s.full_name = '上海市七宝中学浦江分校' AND u.school_name = '七宝中学浦江分校')
  );

-- ============================================
-- 2. 清理初中学校数据（删除不应该存在的记录）
-- ============================================

-- 删除明显的初中学校
DELETE FROM ref_admission_score_unified
WHERE year = 2025 AND (
  school_name LIKE '%初级中学%'
  OR school_name LIKE '%初级学校%'
  -- 明确的初中学校列表
  OR school_name IN (
    -- 黄浦区初中
    '上海市卢湾中学', '上海市尚文中学', '上海市李惠利中学', '上海市比乐中学',
    '上海市民办明珠中学', '上海市清华中学', '上海市震旦外国语中学',
    '上海市黄浦区教育学院附属中山学校', '上海民办永昌学校', '上海民办立达中学',
    -- 徐汇区初中
    '上海市位育初级中学', '上海市南洋模范初级中学', '上海市园南中学',
    '上海市田林中学', '上海师范大学第三附属实验学校', '上海民办南模中学',
    -- 长宁区初中
    '上海市复旦初级中学', '上海市姚连生中学', '上海市娄山中学',
    '上海市开元学校', '上海市新泾中学', '上海市民办新世纪中学',
    '上海市泸定中学', '上海市虹桥中学', '上海市西延安中学',
    -- 静安区初中
    '上海市向东中学', '上海市彭浦第三中学', '上海市静安区教育学院附属学校',
    '同济大学附属七一中学',
    -- 普陀区初中
    '上海市万里城实验学校', '上海市子长学校', '上海市延河中学',
    '上海市普陀区教育学院附属学校', '上海市梅陇中学', '上海市江宁学校',
    '上海市沙田学校', '上海市兴陇中学', '上海市桃浦中学',
    -- 虹口区初中
    '上海市虹口实验学校', '上海市鲁迅初级中学', '上海市民办新华初级中学',
    '上海音乐学院虹口区实验中学', '上海世外教育附属虹口区欧阳学校',
    '上海外国语大学第一实验学校', '上海市第五十二中学',
    -- 杨浦区初中
    '上海市十五中学', '上海音乐学院实验学校', '上海杨浦双语学校',
    '上海市三门中学(上海财经大学附属初级中学）', '上海市东辽阳中学',
    '上海民办兰生中学', '上海市昆明学校', '上海市铁岭中学',
    -- 闵行区初中
    '上海市闵行区七宝文来学校', '上海市七宝第二中学', '上海市闵行区莘松中学',
    -- 宝山区初中
    '上海市宝山实验学校', '上海市吴淞实验学校', '上海市泗塘中学',
    '上海市淞谊中学', '上海市呼玛中学', '上海市宝教院附中',
    -- 嘉定区初中
    '上海市嘉定区震川中学', '上海市嘉定区迎园中学', '上海市嘉定区曹杨二中附属江桥实验中学',
    -- 浦东新区初中
    '上海市浦东新区进才中学北校', '上海市浦东新区建平中学西校', '上海市浦东新区建平实验中学',
    '上海市浦东新区洋泾中学东校', '上海市浦东新区洋泾中学南校', '上海市实验学校东校',
    '上海市浦东新区清流中学', '上海市浦东新区模范中学', '上海市浦东新区由由中学',
    '上海市长岛中学', '上海市泾南中学', '上海市上南中学南校', '上海市三林中学北校',
    '上海市杨思中学', '上海市历城中学', '上海市云台中学', '上海市施湾中学',
    '上海市六团中学', '上海市黄楼中学', '上海市东海学校', '上海市六灶中学',
    '上海市坦直中学',
    -- 金山区初中
    '上海市金山区教育学院附属中学', '上海市金山区蒙山中学', '上海市金山区罗星中学',
    '上海市金山区西林中学', '上海市金山区存志实验中学',
    -- 松江区初中
    '上海市松江区民乐学校', '上海市松江九峰实验学校', '上海市松江区民乐学校',
    -- 青浦区初中
    '上海市青浦区实验中学', '上海市青浦区毓秀学校', '上海市青浦区豫才中学',
    -- 奉贤区初中
    '上海市奉贤区汇贤中学', '上海市奉贤区古华中学', '上海市奉贤区育秀实验学校',
    -- 崇明区初中
    '上海市崇明区实验中学', '上海市崇明区东门中学', '上海市崇明区正大中学'
  )
  -- 带有"中学"但分数线很高（>700）的可能是初中
  OR (school_name LIKE '%中学' AND school_name NOT LIKE '%高级中学' AND min_score > 700)
);

-- 删除附属学校的记录（这些通常是初中）
DELETE FROM ref_admission_score_unified
WHERE year = 2025 AND school_id IS NULL AND (
  school_name LIKE '%附属学校%' AND school_name NOT LIKE '%高级中学%'
  OR school_name LIKE '%附属中学%' AND school_name NOT LIKE '%高级中学%'
)
AND school_name NOT IN (
  -- 保留这些高中
  '复旦大学附属中学', '上海交通大学附属中学', '华东师范大学第二附属中学',
  '上海师范大学附属中学', '上海财经大学附属北郊高级中学', '上海财经大学附属中学'
);
