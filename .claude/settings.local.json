{
  "permissions": {
    "allow": [
      "mcp__plugin_claude-mem_mcp-search__save_memory",
      "Bash(__NEW_LINE_e0b4e878324a942c__ echo \"=== New structure overview ===\")",
      "Bash(__NEW_LINE_88b5603015931104__ echo \"=== æœ€ç»ˆç›®å½•ç»“æ„å®Œæˆ ===\")",
      "Bash(wc:*)",
      "Bash(grep:*)",
      "Bash(python3:*)",
      "Bash(xargs:*)",
      "Bash(for:*)",
      "Bash(do basename:*)",
      "Bash(done)",
      "Bash(/Users/wangzhigang/workspace/wzgown/highschool/scripts/generate_middle_schools_sql.py << 'SCRIPTEND'\n#!/usr/bin/env python3\n\"\"\"\nä»åé¢åˆ†é…åˆ°æ ¡æ•°æ®ä¸­æå–åˆä¸­å­¦æ ¡åˆ—è¡¨\nç”Ÿæˆåˆä¸­å­¦æ ¡ seed SQL\n\"\"\"\n\nimport csv\nimport glob\nimport os\nfrom pathlib import Path\nfrom collections import defaultdict\n\n# åŒºå¿ä»£ç æ˜ å°„\nDISTRICT_CODE_MAP = {\n    'é»„æµ¦åŒº': 'HP',\n    'å¾æ±‡åŒº': 'XH',\n    'é•¿å®åŒº': 'CN',\n    'é™å®‰åŒº': 'JA',\n    'æ™®é™€åŒº': 'PT',\n    'è™¹å£åŒº': 'HK',\n    'æ¨æµ¦åŒº': 'YP',\n    'é—µè¡ŒåŒº': 'MH',\n    'å®å±±åŒº': 'BS',\n    'å˜‰å®šåŒº': 'JD',\n    'æµ¦ä¸œæ–°åŒº': 'PD',\n    'é‡‘å±±åŒº': 'JS',\n    'æ¾æ±ŸåŒº': 'SJ',\n    'é’æµ¦åŒº': 'QP',\n    'å¥‰è´¤åŒº': 'FX',\n    'å´‡æ˜åŒº': 'CM',\n}\n\n# ä»æ–‡ä»¶åæå–åŒºåçš„æ˜ å°„ï¼ˆå¤„ç†å¸¦æ‹¬å·çš„æ–‡ä»¶åï¼‰\nDISTRICT_FROM_FILENAME = {\n    'å˜‰å®šåŒº': \\('JD', 'å˜‰å®šåŒº'\\),\n    'å¥‰è´¤åŒº': \\('FX', 'å¥‰è´¤åŒº'\\),\n    'å®å±±åŒº': \\('BS', 'å®å±±åŒº'\\),\n    'æ™®é™€åŒº': \\('PT', 'æ™®é™€åŒº'\\),\n    'æ¾æ±ŸåŒº': \\('SJ', 'æ¾æ±ŸåŒº'\\),\n    'å¾æ±‡åŒº': \\('XH', 'å¾æ±‡åŒº'\\),\n    'æ¨æµ¦åŒº': \\('YP', 'æ¨æµ¦åŒº'\\),\n    'æµ¦ä¸œåŒº': \\('PD', 'æµ¦ä¸œæ–°åŒº', 'æµ¦ä¸œåŒº'\\),\n    'é—µè¡ŒåŒº': \\('MH', 'é—µè¡ŒåŒº'\\),\n    'é’æµ¦åŒº': \\('QP', 'é’æµ¦åŒº'\\),\n    'é™å®‰åŒº': \\('JA', 'é™å®‰åŒº'\\),\n    'é»„æµ¦åŒº': \\('HP', 'é»„æµ¦åŒº'\\),\n    'é‡‘å±±åŒº': \\('JS', 'é‡‘å±±åŒº'\\),\n    'å´‡æ˜åŒº': \\('CM', 'å´‡æ˜åŒº'\\),\n}\n\n# åŠåˆ«æ˜ å°„\nNATURE_CODE = 'PUBLIC'\n\n\ndef escape_sql\\(text\\):\n    \"\"\"è½¬ä¹‰SQLå­—ç¬¦ä¸²\"\"\"\n    if not text:\n        return ''\n    return text.replace\\(\"'\", \"''\"\\)\n\n\ndef detect_district_from_filename\\(filename\\):\n    \"\"\"ä»æ–‡ä»¶åæ£€æµ‹æ‰€å±åŒº - ä¼˜å…ˆåŒ¹é…æ›´é•¿çš„åŒºå\"\"\"\n    # æŒ‰é•¿åº¦é™åºæ’åˆ—ï¼Œä¼˜å…ˆåŒ¹é…æ›´å…·ä½“çš„åŒºå\n    district_patterns = [\n        \\('å˜‰å®šåŒº', 'JD'\\),\n        \\('å¥‰è´¤åŒº', 'FX'\\),\n        \\('å®å±±åŒº', 'BS'\\),\n        \\('æ™®é™€åŒº', 'PT'\\),\n        \\('æ¾æ±ŸåŒº', 'SJ'\\),\n        \\('å¾æ±‡åŒº', 'XH'\\),\n        \\('æ¨æµ¦åŒº', 'YP'\\),\n        \\('æµ¦ä¸œæ–°åŒº', 'PD'\\),\n        \\('æµ¦ä¸œåŒº', 'PD'\\),\n        \\('é—µè¡ŒåŒº', 'MH'\\),\n        \\('é’æµ¦åŒº', 'QP'\\),\n        \\('é™å®‰åŒº', 'JA'\\),\n        \\('é»„æµ¦åŒº', 'HP'\\),\n        \\('é‡‘å±±åŒº', 'JS'\\),\n        \\('å´‡æ˜åŒº', 'CM'\\),\n        \\('ä¸Šæµ·å¸‚', 'SH'\\),\n    ]\n    \n    for district_name, code in district_patterns:\n        if district_name in filename:\n            return code\n    \n    return None\n\n\ndef parse_jiading_format\\(file_path, district_code\\):\n    \"\"\"è§£æå˜‰å®šåŒºæ ¼å¼çš„æ–‡ä»¶\"\"\"\n    middle_schools = set\\(\\)\n\n    with open\\(file_path, 'r', encoding='utf-8'\\) as f:\n        reader = csv.DictReader\\(f\\)\n        for row in reader:\n            # ç¬¬ä¸€åˆ—\"åˆä¸­å­¦æ ¡\"çš„å€¼å°±æ˜¯å­¦æ ¡åç§°\n            middle_school_name = row.get\\('åˆä¸­å­¦æ ¡', ''\\).strip\\(\\)\n\n            # éªŒè¯å®ƒçœ‹èµ·æ¥åƒå­¦æ ¡åç§°ï¼ˆä¸æ˜¯ç©ºæˆ–\"åˆä¸­å­¦æ ¡\"åˆ—åï¼‰\n            if middle_school_name and middle_school_name not in ['', 'åˆä¸­å­¦æ ¡']:\n                # è¿›ä¸€æ­¥éªŒè¯ï¼šä¸å…¨æ˜¯æ•°å­—æˆ–é€—å·\n                if not middle_school_name.replace\\(',', ''\\).replace\\('.', ''\\).isdigit\\(\\):\n                    middle_schools.add\\(middle_school_name\\)\n\n    return middle_schools\n\n\ndef parse_fengxian_format\\(file_path, district_code\\):\n    \"\"\"è§£æå¥‰è´¤åŒº/é€šç”¨æ ¼å¼çš„æ–‡ä»¶\"\"\"\n    middle_schools = {}\n\n    with open\\(file_path, 'r', encoding='utf-8'\\) as f:\n        reader = csv.DictReader\\(f\\)\n        for row in reader:\n            # æŸ¥æ‰¾åˆä¸­å­¦æ ¡ä»£ç åˆ—\n            code = row.get\\('åˆä¸­å­¦æ ¡ä»£ç ', ''\\).strip\\(\\) or row.get\\('æ ¡ä»£ç ', ''\\).strip\\(\\)\n            name = row.get\\('åˆä¸­å­¦æ ¡åç§°', ''\\).strip\\(\\)\n\n            if code and name:\n                middle_schools[code] = {\n                    'name': name,\n                    'short_name': name[:6] if len\\(name\\) > 6 else name,\n                    'district_code': district_code,\n                }\n\n    return middle_schools\n\n\ndef scan_quota_school_files\\(\\):\n    \"\"\"æ‰«ææ‰€æœ‰åé¢åˆ†é…åˆ°æ ¡æ–‡ä»¶ï¼Œæå–åˆä¸­å­¦æ ¡\"\"\"\n    base_path = Path\\('/Users/wangzhigang/workspace/wzgown/highschool/original_data/raw/2024/quota_school'\\)\n\n    all_middle_schools = {}\n\n    # ä½¿ç”¨ glob è·å–æ‰€æœ‰ CSV æ–‡ä»¶\n    csv_files = list\\(base_path.glob\\('*.csv'\\)\\)\n\n    print\\(f\"ğŸ“‚ æ‰¾åˆ° {len\\(csv_files\\)} ä¸ªæ–‡ä»¶\"\\)\n\n    for file_path in sorted\\(csv_files\\):\n        filename = os.path.basename\\(file_path\\)\n        print\\(f\"ğŸ“– å¤„ç†: {filename}\"\\)\n\n        # æ£€æµ‹åŒºå\n        district_code = detect_district_from_filename\\(filename\\)\n\n        if not district_code:\n            print\\(f\"  âš ï¸  æ— æ³•è¯†åˆ«åŒºåï¼Œè·³è¿‡\"\\)\n            continue\n\n        # é€‰æ‹©è§£ææ–¹å¼\n        if district_code == 'JD':  # å˜‰å®šåŒºæ ¼å¼\n            schools = parse_jiading_format\\(file_path\\)\n            for name in schools:\n                code = f'JD{len\\(all_middle_schools\\)+1:04d}'\n                all_middle_schools[code] = {\n                    'name': name,\n                    'short_name': name[:6] if len\\(name\\) > 6 else name,\n                    'district_code': district_code,\n                    'district_name': 'å˜‰å®šåŒº',\n                }\n        elif district_code == 'FX':  # å¥‰è´¤åŒºæ ¼å¼\n            schools = parse_fengxian_format\\(file_path, district_code\\)\n            for code, info in schools.items\\(\\):\n                all_middle_schools[code] = info\n        else:\n            # å…¶ä»–åŒºä½¿ç”¨å˜‰å®šåŒºæ ¼å¼ï¼ˆé»˜è®¤ï¼‰\n            schools = parse_jiading_format\\(file_path\\)\n            for name in schools:\n                code = f'{district_code}{len\\(all_middle_schools\\)+1:04d}'\n                all_middle_schools[code] = {\n                    'name': name,\n                    'short_name': name[:6] if len\\(name\\) > 6 else name,\n                    'district_code': district_code,\n                    'district_name': DISTRICT_FROM_FILENAME.get\\(district_code, ['']\\)[0],\n                }\n\n    return all_middle_schools\n\n\ndef generate_middle_school_sql\\(\\):\n    \"\"\"ç”Ÿæˆåˆä¸­å­¦æ ¡ SQL\"\"\"\n    middle_schools = scan_quota_school_files\\(\\)\n\n    output_file = Path\\('/Users/wangzhigang/workspace/wzgown/highschool/db/seeds/040_seed_middle_schools_2024.sql'\\)\n\n    sql_lines = []\n    sql_lines.append\\(\"-- ============================================================================\"\\)\n    sql_lines.append\\(\"-- 2024å¹´åˆä¸­å­¦æ ¡åå• - ç§å­æ•°æ®ï¼ˆä»åé¢åˆ†é…åˆ°æ ¡æ•°æ®æå–ï¼‰\"\\)\n    sql_lines.append\\(\"-- æ•°æ®æ¥æº: raw/2024/quota_school/*.csvï¼ˆå…±12ä¸ªåŒºæ–‡ä»¶ï¼‰\"\\)\n    sql_lines.append\\(\"-- æ³¨ï¼šä¸é€‰æ‹©ç”Ÿæºåˆä¸­é»˜è®¤ä¸ºTRUEï¼Œé€‚ç”¨äºåé¢åˆ†é…åˆ°æ ¡å¡«æŠ¥èµ„æ ¼åˆ¤æ–­\"\\)\n    sql_lines.append\\(\"-- æ³¨ï¼šæ­¤æ•°æ®ä»…åŒ…å«æœ‰åé¢åˆ†é…åˆ°æ ¡çš„åˆä¸­å­¦æ ¡\"\\)\n    sql_lines.append\\(\"-- ============================================================================\"\\)\n    sql_lines.append\\(\"\"\\)\n\n    # æŒ‰åŒºå¿åˆ†ç»„\n    district_groups = defaultdict\\(list\\)\n    for code, info in middle_schools.items\\(\\):\n        district_groups[info['district_code']].append\\(\\(code, info\\)\\)\n\n    # æŒ‰åŒºå¿ä»£ç é¡ºåºç”Ÿæˆ\n    district_order = ['HP', 'XH', 'CN', 'JA', 'PT', 'HK', 'YP', 'MH', 'BS', 'JD', 'PD', 'JS', 'SJ', 'QP', 'FX', 'CM']\n\n    for district_code in district_order:\n        if district_code not in district_groups:\n            continue\n\n        schools = district_groups[district_code]\n        if not schools:\n            continue\n\n        # è·å–ä¸­æ–‡åç§°\n        district_cn = next\\(\\(k for k, v in DISTRICT_FROM_FILENAME.items\\(\\) if v == district_code\\), ''\\)\n\n        sql_lines.append\\(f\"-- {district_cn}\"\\)\n\n        for code, info in sorted\\(schools, key=lambda x: x[1]['name']\\):\n            school_name = escape_sql\\(info['name']\\)\n            short_name = school_name[:6] if len\\(school_name\\) > 6 else school_name\n\n            sql_lines.append\\(f\"-- {school_name}\"\\)\n            sql_lines.append\\(\"INSERT INTO ref_middle_school \\(code, name, short_name, district_id, school_nature_id, is_non_selective, data_year, is_active\\) VALUES\"\\)\n            sql_lines.append\\(f\"    '{code}', '{school_name}', '{short_name}',\"\\)\n            sql_lines.append\\(f\"    \\(SELECT id FROM ref_district WHERE code = '{district_code}'\\), '{NATURE_CODE}', TRUE, 2024, TRUE\\)\"\\)\n            sql_lines.append\\(\"ON CONFLICT \\(code, data_year\\) DO UPDATE SET\"\\)\n            sql_lines.append\\(\"    name = EXCLUDED.name,\"\\)\n            sql_lines.append\\(\"    short_name = EXCLUDED.short_name,\"\\)\n            sql_lines.append\\(\"    district_id = EXCLUDED.district_id,\"\\)\n            sql_lines.append\\(\"    updated_at = CURRENT_TIMESTAMP;\"\\)\n            sql_lines.append\\(\"\"\\)\n\n    # å†™å…¥æ–‡ä»¶\n    with open\\(output_file, 'w', encoding='utf-8'\\) as f:\n        f.write\\('\\\\n'.join\\(sql_lines\\)\\)\n\n    print\\(f\"âœ… å·²ç”Ÿæˆ: {output_file}\"\\)\n\n    # ç»Ÿè®¡è¾“å‡º\n    print\\(\"\\\\nğŸ“Š å„åŒºå­¦æ ¡ç»Ÿè®¡:\"\\)\n    district_counts = {}\n    for code, info in middle_schools.items\\(\\):\n        district_counts[info['district_code']] = district_counts.get\\(info['district_code'], 0\\) + 1\n\n    for district_code in district_order:\n        count = district_counts.get\\(district_code, 0\\)\n        if count > 0:\n            district_cn = next\\(\\(k for k, v in DISTRICT_CODE_MAP.items\\(\\) if v == district_code\\), ''\\)\n            print\\(f\"   {district_cn}: {count} æ‰€\"\\)\n\n\nif __name__ == '__main__':\n    generate_middle_school_sql\\(\\)\nSCRIPTEND)",
      "Bash(/Users/wangzhigang/workspace/wzgown/highschool/scripts/unify_middle_schools.py << 'EOF'\n#!/usr/bin/env python3\n\"\"\"ç»Ÿä¸€å¹¶æå–æ‰€æœ‰åŒºçš„åˆä¸­å­¦æ ¡æ•°æ®\"\"\"\n\nimport csv\nimport os\nfrom pathlib import Path\n\n# é…ç½®\nunified_dir = Path\\('/Users/wangzhigang/workspace/wzgown/highschool/original_data/processed/quota_school'\\)\n\n# åŒºåæ˜ å°„\nDISTRICTS = {\n    'HP': \\('é»„æµ¦åŒº', 'é»„æµ¦'\\),\n    'XH': \\('å¾æ±‡åŒº', 'å¾æ±‡'\\),\n    'CN': \\('é•¿å®åŒº', 'é•¿å®'\\),\n    'JA': \\('é™å®‰åŒº', 'é™å®‰'\\),\n    'PT': \\('æ™®é™€åŒº', 'æ™®é™€'\\),\n    'HK': \\('è™¹å£åŒº', 'è™¹å£'\\),\n    'YP': \\('æ¨æµ¦åŒº', 'æ¨æµ¦'\\),\n    'MH': \\('é—µè¡ŒåŒº', 'é—µè¡Œ'\\),\n    'BS': \\('å®å±±åŒº', 'å®å±±'\\),\n    'JD': \\('å˜‰å®šåŒº', 'å˜‰å®š'\\),\n    'PD': \\('æµ¦ä¸œæ–°åŒº', 'æµ¦ä¸œ'\\),\n    'JS': \\('é‡‘å±±åŒº', 'é‡‘å±±'\\),\n    'SJ': \\('æ¾æ±ŸåŒº', 'æ¾æ±Ÿ'\\),\n    'QP': \\('é’æµ¦åŒº', 'é’æµ¦'\\),\n    'FX': \\('å¥‰è´¤åŒº', 'å¥‰è´¤'\\),\n    'CM': \\('å´‡æ˜åŒº', 'å´‡æ˜'\\),\n}\n\ndef detect_district\\(filename\\):\n    for code, names in DISTRICTS.items\\(\\):\n        for name in names:\n            if name in filename:\n                return code\n    return None\n\ndef parse_standard\\(file_path\\):\n    \"\"\"è§£ææ ‡å‡†æ ¼å¼\"\"\"\n    schools = {}\n    with open\\(file_path, 'r', encoding='utf-8'\\) as f:\n        reader = csv.DictReader\\(f\\)\n        for row in reader:\n            code = row.get\\('å­¦æ ¡ç¼–å·', ''\\).strip\\(\\)\n            name = row.get\\('å­¦æ ¡åç§°', ''\\).strip\\(\\)\n            if code and name:\n                schools[code] = {\n                    'name': name,\n                    'short_name': name[:6] if len\\(name\\) > 6 else name,\n                    'district_code': 'STANDARD',\n                }\n\n    return schools\n\ndef parse_info_format\\(file_path\\):\n    \"\"\"è§£æä¿¡æ¯æ ¼å¼\"\"\"\n    schools = {}\n    with open\\(file_path, 'r', encoding='utf-8'\\) as f:\n        reader = csv.DictReader\\(f\\)\n        for row in reader:\n            if not row.get\\('åˆä¸­å­¦æ ¡åç§°'\\):\n                continue\n            code = row.get\\('åˆä¸­å­¦æ ¡ä»£ç ', ''\\).strip\\(\\)\n            name = row.get\\('åˆä¸­å­¦æ ¡åç§°', ''\\).strip\\(\\)\n            nature = 'PRIVATE' if 'æ°‘åŠ' in name else 'PUBLIC'\n            if code and name:\n                schools[code] = {\n                    'name': name,\n                    'short_name': name[:6] if len\\(name\\) > 6 else name,\n                    'district_code': 'INFO',\n                }\n\n    return schools\n\ndef parse_jiading_format\\(file_path\\):\n    \"\"\"è§£æå˜‰å®šæ ¼å¼\"\"\"\n    schools = set\\(\\)\n    with open\\(file_path, 'r', encoding='utf-8'\\) as f:\n        reader = csv.DictReader\\(f\\)\n        for row in reader:\n            name = row.get\\('åˆä¸­å­¦æ ¡', ''\\).strip\\(\\)\n            if name and name not in ['', 'åˆä¸­å­¦æ ¡']:\n                if not name.replace\\(',', ''\\).replace\\('.', ''\\).isdigit\\(\\):\n                    schools.add\\(name\\)\n\n    return schools\n\ndef process_files\\(\\):\n    \"\"\"å¤„ç†æ‰€æœ‰æ–‡ä»¶\"\"\"\n    all_schools = {}\n    base_path = Path\\('/Users/wangzhigang/workspace/wzgown/highschool/original_data/raw/2024/quota_school'\\)\n    csv_files = sorted\\(base_path.glob\\('*.csv'\\)\\)\n\n    for file_path in csv_files:\n        filename = os.path.basename\\(file_path\\)\n        district = detect\\(filename\\)\n\n        if not district:\n            print\\(f\"è·³è¿‡: {filename}\"\\)\n            continue\n\n        print\\(f\"å¤„ç†: {filename}\"\\)\n\n        if district == 'STANDARD':\n            schools = parse_standard\\(file_path\\)\n        elif district == 'INFO':\n            schools = parse_info_format\\(file_path\\)\n        else:\n            schools = parse_jiading_format\\(file_path\\)\n\n        for code, info in schools.items\\(\\):\n            all_schools[code] = info\n\n    return all_schools\n\n# å¤„ç†æ–‡ä»¶å¹¶ç”Ÿæˆ\nall_schools = process_files\\(\\)\n\noutput_file = unified_dir / 'middle_schools_2024_unified.csv'\n\nwith open\\(output_file, 'w', encoding='utf-8', newline=''\\) as f:\n    writer = csv.writer\\(f\\)\n    writer.writerow\\(['åºå·', 'å­¦æ ¡ä»£ç ', 'å­¦æ ¡åç§°', 'åŠåˆ«', 'æ‰€å±åŒº']\\)\n\n    rows = []\n    for code, info in sorted\\(all_schools.items\\(\\), key=lambda x: int\\(x[0]\\)\\):\n        rows.append\\([len\\(rows\\)+1, code, info['name'], info.get\\('nature', 'PUBLIC'\\), 'STANDARD']\\)\n\n    writer.writerows\\(rows\\)\n\nprint\\(f\"æ€»å­¦æ ¡æ•°: {len\\(all_schools\\)}\"\\)\nprint\\(f\"å·²ç”Ÿæˆ: {output_file}\"\\)\nEOF)",
      "Bash(ls:*)"
    ]
  }
}
